<?xml version="1.0" encoding="UTF-8"?>
<project name = "Perga.by" basedir=".." default = "dist" description="My own project">
    <property name = "buildDir" value = "${project.basedir}/build" override = "true" />
    <property name = "archiveFile" value = "${buildDir}/build.tar.gz" override = "true" />

    <fileset dir="${buildDir}" id="cleanBuildDirectory">
        <include name="**/**" />
        <exclude name ="build.tar.gz"/>
    </fileset>

    <target name = "prepare">
        <echo msg = "Making directory ./build" />
        <mkdir dir = "./build" />
        <exec command="php app/console assetic:dump --env=prod --no-debug" logoutput = "true" />
    </target>

    <fileset dir = "${project.basedir}" id = "allfiles">
        <include name = "**/**" />
        <exclude name="build/**"/>
        <exclude name="app/cache/**"/>
        <exclude name="app/logs/**"/>
        <exclude name=".idea/**"/>
        <exclude name=".git/**"/>
        <exclude name="scripts/**"/>
        <exclude name="app/config/parameters.yml.dist"/>
        <exclude name="app/config/parameters.yml"/>
        <exclude name="app/config/parameters.yml.conf"/>
    </fileset>

    <target name = "copy" description = "main target" depends="prepare">
        <echo msg = "Copy all files to ${buildDir} directory" />
        <copy todir = "${buildDir}">
            <fileset refid = "allfiles" />
        </copy>

        <copy file="${buildDir}/app/config/parameters.yml.conf.prod" tofile="${buildDir}/app/config/parameters.yml" />
        <delete file="${buildDir}/app/config/parameters.yml.conf.prod" />
        <mkdir dir = "${buildDir}/app/cache"/>
        <chmod file="${buildDir}/app/cache" mode="0777" />
        <mkdir dir = "${buildDir}/app/logs"/>
        <chmod file="${buildDir}/app/logs" mode="0777" />
    </target>

    <target name = "dist" depends = "copy">
        <echo msg = "Creating archive..." />
        <tar destfile = "${archiveFile}" compression = "gzip">
            <fileset dir = "${buildDir}">
                <include name = "**/**" />
            </fileset>
        </tar>
        <echo msg = "archive have done" />
        <phingcall target="clean" />
    </target>

    <target name="clean">
        <echo msg = "Clean build directory" />
        <delete>
            <fileset refid="cleanBuildDirectory" />
        </delete>
        <delete dir="${buildDir}/app" />
        <delete dir="${buildDir}/bin" />
        <delete dir="${buildDir}/vendor" />
        <delete dir="${buildDir}/web" />
        <delete dir="${buildDir}/src" />
    </target>

</project>